# эксперимент с патчем фильтрации серверов

### Инструкция по воспроизведению:
1. поднимем hash сервер любой папке на вашем компьютере с помощью команды: `bitbake-hashserv -b :8686`
2. поднимаем на компьютере №2 кэш сервер. Я поднял на пк с ip `10.138.70.7` пользователем `user` и порте `9999`
3. теперь сконфигурируем эксперимент:  
  
    a. конфигурация в `auto_compose_local_conf.py`
    ```py
    target_working_server_port = 9999  # то, какой порт на кэш серевере открыт и используется для раздачи кэша
    hash_ip_port = f'0.0.0.0:{8686}'  #  то, на каком порту размещщен локальный хэш сервере из п.1
    cache_ip =  '10.138.70.7'  # ip пк, на котором раздается кэш
    cache_start_port = 8150  # начальный диапозон портов
    cache_num_port = 50  # количество используемых портов (от 2 до этого значение +1 будет проведен эксперимент)
    ```  
    b. конфигурация в `run.sh`
    ```bash
    max_servers=50 -- максимальное значение количества серверов (минус 1, по факту будут измерятсья 50+1)
    step=1 - щаг итерации 
    ```
    Там же можно выбрать версию poky указав другой хэш коммит
4. можем запускать с помощью `./run.sh`

### Логика работы
1. в файле `auto_compose_local_conf.py` формируются local.conf файлы под эксперимент, которые кладутся в папку `./configs/<количество_серверов>/local.conf`
2. если poky нет в текущей папке, он кланируется и переводтся в состояние определенного хэш-коммита (`59db27de565fb33f9e4326e76ebd6fa3935557b9`)
3. происходит копирование патча и его применение
4. в скрипте проводятся сразу 2 эксперимента -- как было бы до патча и как будет после, потому блок с перезапуском сборок повторяется почти полностью (заисключенирем имен выходных файлов, чтобы вторая серия перезапусков не затирла первую), однако первый раз блок прогоняется без применения патча фильтрации (применяется только патч замера времени), а второй раз - с применением патча.
5. рассмотрим блок итеративного перезапуска. В нем происходится активация окружения (`source oe-init-build-env`), копирование конфигурации, созданной в шаге 1, запуск сборки и сохранение логов, удаление директории сборки. 
