## Инструкция по применению патча cachefiles.patch

1. Переместить патч cachefiles.patch в директорию poky/meta/classes-global/.
2. Применить патч: patch -p1 sstate.bbclass < cachefiles.patch
3. Запустить сборку


## Принцип работы
В файле index.txt лежат данные о тех файлах, которые находятся на зеркале - пути до них.
Файл index.txt - это индекс-файл, составляющийся автоматически после заполнения sstate-cache в процессе сборки. 
По сути принцип работы с индекс-файлом следующий:
1) Запускаем сборку, чтобы сгенерировать кэш, который впоследствии положим на кэш-сервер. В этот момент генерируется и индекс-файл. Чтобы он сгенерировался, должен быть применен этот патч: https://github.com/moevm/os_profiling/blob/ba530d158b228de3f3bbcff3f738fc559a0afa5b/src/index_developments/diff.txt
2) Кладем всю папку sstate-cache на кэш-сервер вместе с индекс-файлом (он будет внутри папки sstate-cache).
3) При запуске последующих сборок (с настроенной конфигурацией для кэш-сервера) происходят действия, описанные ниже:

После применения патча cachefiles.patch к файлу sstate.bbclass логика опроса зеркал изменяется, и становится следующей:
Происходит итерирование по зеркалам, с каждого зеркала пытаемся получить содержимое файла index.txt, в данный момент в патч добавлена поддержка для http и ftp протоколов. В случае успеха (мы прочитали содержимое этого файла), bitbake определяет, какие задачи из данного списка ему "подходят", и переиспользует их. Если в процессе опроса мы не смогли получить содержимое данного файла с какого-нибудь зеркала (например, потому что на зеркале не было такого файлика, или сервер устроен по другому протоколу, для которого нет поддержки), то тогда данное зеркало будет проверяться по исходному алгоритму bitbake'a.


## Результаты, измерение ускорения
Был проведен ряд экспериментов по измерению времени сверки хэш-значений. Каждый из алгоритмов (оптимизированный и стандартный) был запущен по 7 раз.

В результате оказалось, что:
1) среднее время выполнения сверки хэш-значений по оптимизированному алгоритму составляет около 0.052 секунды.
2) среднее время выполнения сверки хэш-значений по неоптимизированному (стандартному) алгоритму составляет около 32,882 секунды.

Таким образом, получаем ускорение в ~632 раза.

Эксперименты проводились при конфигурации с одним зеркалом, настроенным по протоколу http. 


Также были проведены аналогичные эксперименты сначала с 3, а потом с 15 зеркалами, чтобы увидеть, как время сверки сигнатур зависит от количества зеркал. 
Результаты с 3 зеркалами:
1) среднее время выполнения сверки хэш-значений по оптимизированному алгоритму с 3 зеркалами составило около 0.174 секунды
2) среднее время выполнения сверки хэш-значений по неоптимизированному (стандартному) алгоритму с 3 зеркалами составило около 67.6 секунд

Результаты с 15 зеркалами:
1) среднее время выполнения сверки хэш-значений по оптимизированному алгоритму с 15 зеркалами составило около 0.254 секунды
2) среднее время выполнения сверки хэш-значений по неоптимизированному (стандартному) алгоритму с 15 зеркалами составило около 194.7 секунд
