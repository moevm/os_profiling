# Создание хэш сервера
Выполняем команду `. poky/oe-init-build-env` чтобы можно было использовать bitbake     


Переходим туда, где у нас лежит кэш и прописываем команду `bitbake-hashserv -r -b :8686`  --  флаг `-b` позваоляет указать порт - `:8686`


В это время создается файл `hashserv.db` 

# Конфигурация удаленной сборки и сборка
### Конфигурация
Для конфигурации удаленной сборки с сервером хэша для кэша используем следующий файл local.conf
```bash
MACHINE ??= "qemux86-64" 
DL_DIR ?= "${TOPDIR}/downloads"
SSTATE_DIR ?= "${TOPDIR}/sstate-cache"
DISTRO ?= "poky"
PACKAGE_CLASSES ?= "package_ipk"

SOURCE_MIRROR_URL ?= "\
file://.* http://127.0.0.1:8080/downloads/PATH;downloadfilename=PATH"

SSTATE_MIRRORS ?= "\
file://.* http://127.0.0.1:8080/sstate-cache/PATH;downloadfilename=PATH"


# все что ниже - важно в контексте настройки заркал, но в будущем будет важно для настройки хэш сервера
BB_HASHSERVE = "auto"  # говорим серверу сравнивать сигнатуры в автоматическом режиме
BB_HASHSERVE_UPSTREAM = "127.0.0.1:8686"  # указываем ip и порт хэш сервера
BB_SIGNATURE_HANDLER = "OEEquivHash"  # указываем то, как нужно обработать сигнатуры
CONF_VERSION = "2"
```
### Сборка

Запускаем сборку `bitbake core-image-minimal`   
![Screenshot from 2024-05-07 15-05-24](https://github.com/moevm/os_profiling/assets/90711883/c8ef96d7-8ae6-4b0f-800f-4b6d102d2db0)


Видно, что 93% объема задач сборки загрузились из кэша (при той же конфигурации, но без хэш сервера, подгрузилось только 60%) 

### Возможные проблемы и способы их решения: 
1) во время оригинальной сборки также формируется файл `hashserv.db` -- возможно получится его подключить к новой сборке
2) во время оригинальной сборки использовался `PACKAGE_CLASSES` возможно отличный от  "package_ipk" -- я не знаю какой используется по умолчания

При устранении проблемы 2 появилась позитивная тенденция:  
![Screenshot from 2024-05-07 15-21-31](https://github.com/moevm/os_profiling/assets/90711883/0f575022-248c-44a0-8c55-961d7bbeed25)  

Видно, что тут из кэша загрузилось 99% задач.   
**Вывод**: Чтобы повышать производительность нужно (по возможности) настраивать дочерние сборки как ту, что раздает кэш
