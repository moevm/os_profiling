# Создание хэш сервера
Выполняем команду `. poky/oe-init-build-env` чтобы можно было использовать bitbake     


Переходим туда, где у нас лежит кэш и прописываем команду `bitbake-hashserv -r -b :8686`  --  флаг `-b` позваоляет указать порт - `:8686`


В это время создается файл `hashserv.db` 
### Зачем он нужен?
По умолчанию работает локальный хэш сервер -- он производит сверку сигнатур и валидацию кэшей пакетов сборки из локльной папки sstate-cache. Эта валидация занимает некоторое время, потому в Bitbake предусмотрена возможность использования сторонних хэш серверов для валидации кэша.  
Однако, если мы используем зеркала кэша, то локальный (стандартный) хэш сервер bitbake не обрабатывает эти зеркала. Если мы подключим зеркала, но не зададим конфигурацию хэш сервера, появится предупреждение от сборщика:
> [!WARNING]
> "WARNING: You are using a local hash equivalence server but have configured an sstate mirror. This will likely mean no sstate will match from the mirror. You may wish to disable the hash equivalence use (BB_HASHSERVE), or use a hash equivalence server alongside the sstate mirror."  


Примерный перевод этого предупреждения:  
> [!WARNING]
> "ВНИМАНИЕ: вы используете локальный хэш сервер, но настроили зеркало sstate кэша. Скорее всего, это будет означать, что ни одно состояние не будет соответствовать зеркалу. Возможно, вы захотите отключить использование хеш-эквивалентности (BB_HASHSERVE) или использовать сервер хеш-эквивалентности рядом с зеркалом sstate."  

В этом сообщение содержится два тезиса:
1) возможно мы не хотим сравнивать сигнатуры и получается делать сборку "с нуля"
2) возможно мы производим сборку на том же компьютере, где у нас размещен кэш, тогда можно указать локальный путь к этому кэшу.

> [!IMPORTANT]
> Вывод:
> Если мы настраиваем сервер кэша, котоырй потенциально должен работать удаленно - мы должны создать и хэш сервер, который будет сравнивать сигнатуры кэшированных паектов.

# Конфигурация удаленной сборки и сборка
### Конфигурация old Yocto
Для конфигурации удаленной сборки с сервером хэша для кэша используем следующий файл local.conf
```bash
MACHINE ??= "qemux86-64" 
DL_DIR ?= "${TOPDIR}/downloads"
SSTATE_DIR ?= "${TOPDIR}/sstate-cache"
DISTRO ?= "poky"
PACKAGE_CLASSES ?= "package_ipk"

SOURCE_MIRROR_URL ?= "\
file://.* http://127.0.0.1:8080/downloads/PATH;downloadfilename=PATH"

SSTATE_MIRRORS ?= "\
file://.* http://127.0.0.1:8080/sstate-cache/PATH;downloadfilename=PATH"


# все что ниже - важно в контексте настройки заркал, но в будущем будет важно для настройки хэш сервера
BB_HASHSERVE = "auto" 
BB_HASHSERVE_UPSTREAM = "127.0.0.1:8686"  
BB_SIGNATURE_HANDLER = "OEEquivHash"
CONF_VERSION = "2"
```

### Конфигурация New Yocto (5.0)
В новой версии yocto поменялся стандартный local.conf файл, потому инструкция выше - не будет валидна.  
> [!NOTE]
> Предлагаю поступить следущем образом -- стараемся делать файлы local.conf в сборке максимально похожим на ту сборку, из который выгружаем кэш -- в этом случае совспадение по сигнатурам будет высоким, а в конце файла, перед строкой `CONF_VERSION = "2"`  вписываем следующие конфигурации:

```sh
SOURCE_MIRROR_URL ?= "\
file://.* http://10.138.70.218:8888/downloads/PATH;downloadfilename=PATH"

SSTATE_MIRRORS ?= "\
file://.* http://10.138.70.218:8888/sstate-cache/PATH;downloadfilename=PATH"

BB_HASHSERVE = "auto"  
BB_HASHSERVE_UPSTREAM = "10.138.70.218:8686"  
BB_SIGNATURE_HANDLER = "OEEquivHash"  
```


### Сборка

Запускаем сборку `bitbake core-image-minimal`   
![Screenshot from 2024-05-07 15-05-24](https://github.com/moevm/os_profiling/assets/90711883/c8ef96d7-8ae6-4b0f-800f-4b6d102d2db0)


Видно, что 93% объема задач сборки загрузились из кэша (при той же конфигурации, но без хэш сервера, подгрузилось только 60%) 

### Возможные проблемы и способы их решения: 
1) во время оригинальной сборки также формируется файл `hashserv.db` -- возможно получится его подключить к новой сборке
2) во время оригинальной сборки использовался `PACKAGE_CLASSES` возможно отличный от  "package_ipk" -- я не знаю какой используется по умолчания

При устранении проблемы 2 появилась позитивная тенденция:  
![Screenshot from 2024-05-07 15-21-31](https://github.com/moevm/os_profiling/assets/90711883/0f575022-248c-44a0-8c55-961d7bbeed25)  

Видно, что тут из кэша загрузилось 99% задач.   
**Вывод**: Чтобы повышать производительность нужно (по возможности) настраивать дочерние сборки как ту, что раздает кэш
