## Общее использование локального кэша

### Входные данные:  
Есть собранный базовый образ системы, располагающийся в `abs_path/build`   
Кэш сборки `abs_path/build/sstate-cache`   
Загруженные исходные данные (код и прочее) `abs_path/build/downloads`   

### Цель
Хотим собрать образ с модификацией или просто в другой локации

### Решение
1) создаем папку build и первичные настройки c помощью `source oe-init-build-env`
2) в папке build/conf необходимо дополнить файл local.conf следующими строкам:

``` bash
BB_NO_NETWORK = "1"
INHERIT += "rm_work"
DL_DIR ?= "abs_path/build/downloads"
SSTATE_DIR ?= "abs_path/build/sstate-cache"
```
Рассмотрим подробно, что здесь конфигурируется:
+ `BB_NO_NETWORK = "1"` - указываем сборщику, что не нужно загружать ничего из сети - использовать только лоакльные файлы
+ `INHERIT += "rm_work"` - если сборка будет успешной - необходимо удалить файлы текущей сборки (у нас уже есть базовый собранный образ, потому не стоит хранить кэш сборки дочерных образов, но если удалить эту строку - все будет работать, так что она опциональная)
+ `DL_DIR ?= "abs_path/build/downloads"` - указываем путь к папке с загруженым исходным кодом
+ `"abs_path/build/sstate-cache"` - указываем путь к папке с кэшем предыдущей сборки

### Эксперимент
Были проделаны шаги из **Решения**, при запуске новой сборки с указанной конфигурацией получили следующий вывод:
```bash
Loading cache: 100% |                                                                                                                                                                                           | ETA:  --:--:--
Loaded 0 entries from dependency cache.
Parsing recipes: 100% |##########################################################################################################################################################################################| Time: 0:00:10
Parsing of 922 .bb files complete (0 cached, 922 parsed). 1878 targets, 47 skipped, 0 masked, 0 errors.
NOTE: Resolving any missing task queue dependencies

Build Configuration:
BB_VERSION           = "2.9.0"
BUILD_SYS            = "x86_64-linux"
NATIVELSBSTRING      = "ubuntu-20.04"
TARGET_SYS           = "x86_64-poky-linux"
MACHINE              = "qemux86-64"
DISTRO               = "poky"
DISTRO_VERSION       = "5.0+snapshot-a88251b3e7077d0baf3af5f4f52928dce94aa41d"
TUNE_FEATURES        = "m64 core2"
TARGET_FPU           = ""
meta                 
meta-poky            
meta-yocto-bsp       = "master:a88251b3e7077d0baf3af5f4f52928dce94aa41d"

Sstate summary: Wanted 2013 Local 1138 Mirrors 0 Missed 875 Current 0 (56% match, 0% complete)################################################################################################                   | ETA:  0:00:00
Initialising tasks: 100% |#######################################################################################################################################################################################| Time: 0:00:01
NOTE: Executing Tasks
NOTE: Tasks Summary: Attempted 4573 tasks of which 1863 didn't need to be rerun and all succeeded.

```


Из сторик `Wanted 2013 Local 1138 ...` видно, что из стороннего локального кэша загрузилось 1138 задач, это привело к тому, что 60% объема сборка завершилось за несколько секунд.

После успешной сборки с использование сторорннего кэша был составлен график, из которого видны два факта:
1) сборка заняла 1560 секунд (26 минут) -- это благодаря тому, что не производилось повторное скачивание материалов
2) Задачи, занимающие большую часть времени - do_cofigure, do_compile, do_package  
![bootchart](https://github.com/moevm/os_profiling/assets/90711883/477ae24a-15cf-474b-b758-ca1d0eb633ac)


### Выводы
Для ускорение сборки образов можно использовать кэш и загруженные исходные данные от предыдущих сборок 
